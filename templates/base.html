<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Media Manager{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .thumbnail-container {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .thumbnail {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .file-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white;
            padding: 10px;
            font-size: 0.8rem;
        }
        .upload-zone {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        .upload-zone.dragover {
            border-color: #0d6efd;
            background-color: #f8f9ff;
        }
        .media-player {
            max-width: 100%;
            max-height: 70vh;
        }
        .dark-mode {
            background-color: #212529;
            color: #ffffff;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .folder-tree {
            max-height: 400px;
            overflow-y: auto;
        }
        .folder-item {
            padding: 4px 8px;
            margin: 2px 0;
            border-radius: 4px;
            transition: background-color 0.2s;
            cursor: pointer;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        .folder-item:hover {
            background-color: rgba(0,123,255,0.1);
        }
        .folder-item.active {
            background-color: rgba(0,123,255,0.2);
            font-weight: bold;
        }
        .folder-actions {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .folder-item:hover .folder-actions {
            opacity: 1;
        }
        .folder-indent {
            margin-left: 20px;
        }
        .navbar-nav .dropdown-menu {
            min-width: 350px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="bi bi-camera-video"></i> Media Manager
            </a>
            
            {% if current_user.is_authenticated %}
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('gallery') }}">
                            <i class="bi bi-grid"></i> Gallery
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('upload') }}">
                            <i class="bi bi-cloud-upload"></i> Upload
                        </a>
                    </li>
                    
                    <!-- Folder Browser Dropdown -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="folderDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-folder-tree"></i> Browse Folders
                        </a>
                        <div class="dropdown-menu" aria-labelledby="folderDropdown">
                            <div class="px-3 py-2">
                                <h6 class="dropdown-header">Media Folders</h6>
                                <div class="mb-2">
                                    <small class="text-muted">Choose a folder to browse</small>
                                </div>
                                
                                <!-- Loading indicator -->
                                <div id="folderLoading" class="text-center py-2">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                
                                <!-- Folder tree container -->
                                <div id="folderTree" class="folder-tree" style="display: none;">
                                    <!-- Folders will be loaded here -->
                                </div>
                                
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="{{ url_for('gallery') }}">
                                    <i class="bi bi-house"></i> All Files
                                </a>
                                {% if current_user.is_admin %}
                                <a class="dropdown-item" href="#" onclick="showFolderManagement()">
                                    <i class="bi bi-gear"></i> Manage Folders
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </li>
                    
                    {% if current_user.is_admin %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin') }}">
                            <i class="bi bi-gear"></i> Admin
                        </a>
                    </li>
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person"></i> {{ current_user.username }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="toggleDarkMode()">
                                <i class="bi bi-moon"></i> Toggle Dark Mode
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">
                                <i class="bi bi-box-arrow-right"></i> Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            {% endif %}
        </div>
    </nav>

    <main class="container mt-4">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <!-- Folder Management Modal -->
    {% if current_user.is_authenticated and current_user.is_admin %}
    <div class="modal fade" id="folderManagementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Folder Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Images</h6>
                            <div id="imageFolders" class="folder-tree">
                                <!-- Image folders will be loaded here -->
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6>Videos</h6>
                            <div id="videoFolders" class="folder-tree">
                                <!-- Video folders will be loaded here -->
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6>Audio</h6>
                            <div id="audioFolders" class="folder-tree">
                                <!-- Audio folders will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="refreshFolderManagement()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Delete Folder Confirmation Modal -->
    {% if current_user.is_authenticated and current_user.is_admin %}
    <div class="modal fade" id="deleteFolderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Folder</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Warning!</strong> This will delete the folder and all its contents.
                    </div>
                    <p>Are you sure you want to delete the folder:</p>
                    <p><strong id="deleteFolderPath"></strong></p>
                    <p class="text-muted small">This action cannot be undone. All files in this folder will be permanently deleted.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteFolder">
                        <i class="bi bi-trash"></i> Delete Folder
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Modals -->
    {% block modals %}{% endblock %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let folderStructureCache = {};
        let currentFolderPath = '';
        let currentFolderType = '';

        function toggleDarkMode() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Load saved theme
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            
            // Load folder structure when dropdown is opened
            const folderDropdown = document.getElementById('folderDropdown');
            if (folderDropdown) {
                folderDropdown.addEventListener('shown.bs.dropdown', loadFolderStructure);
            }
        });

        function loadFolderStructure() {
            const folderTree = document.getElementById('folderTree');
            const folderLoading = document.getElementById('folderLoading');
            
            if (Object.keys(folderStructureCache).length > 0) {
                displayFolderTree(folderStructureCache);
                return;
            }
            
            folderLoading.style.display = 'block';
            folderTree.style.display = 'none';
            
            fetch('/api/folders')
                .then(response => response.json())
                .then(data => {
                    folderStructureCache = data;
                    displayFolderTree(data);
                    folderLoading.style.display = 'none';
                    folderTree.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading folders:', error);
                    folderLoading.innerHTML = '<small class="text-danger">Error loading folders</small>';
                });
        }

        function displayFolderTree(folderData) {
            const folderTree = document.getElementById('folderTree');
            folderTree.innerHTML = '';
            
            Object.keys(folderData).forEach(fileType => {
                if (folderData[fileType].length > 0) {
                    const typeHeader = document.createElement('div');
                    typeHeader.className = 'fw-bold text-primary mb-2 mt-3';
                    typeHeader.innerHTML = `<i class="bi bi-${getTypeIcon(fileType)}"></i> ${fileType.toUpperCase()}`;
                    folderTree.appendChild(typeHeader);
                    
                    renderFolderLevel(folderData[fileType], folderTree, fileType, 0);
                }
            });
        }

        function renderFolderLevel(folders, container, fileType, depth) {
            folders.forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item';
                folderItem.style.marginLeft = (depth * 20) + 'px';
                
                const folderContent = document.createElement('div');
                folderContent.className = 'd-flex justify-content-between align-items-center w-100';
                
                const folderInfo = document.createElement('div');
                folderInfo.className = 'flex-grow-1';
                folderInfo.innerHTML = `<i class="bi bi-folder me-2"></i>${folder.name}`;
                folderInfo.onclick = () => navigateToFolder(folder.path, fileType);
                
                const folderActions = document.createElement('div');
                folderActions.className = 'folder-actions';
                {% if current_user.is_admin %}
                folderActions.innerHTML = `
                    <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteFolder('${folder.path}', '${fileType}')" title="Delete folder">
                        <i class="bi bi-trash"></i>
                    </button>
                `;
                {% endif %}
                
                folderContent.appendChild(folderInfo);
                folderContent.appendChild(folderActions);
                folderItem.appendChild(folderContent);
                container.appendChild(folderItem);
                
                if (folder.children && folder.children.length > 0) {
                    renderFolderLevel(folder.children, container, fileType, depth + 1);
                }
            });
        }

        function getTypeIcon(fileType) {
            const icons = {
                'image': 'image',
                'video': 'play-circle',
                'audio': 'music-note'
            };
            return icons[fileType] || 'folder';
        }

        function navigateToFolder(folderPath, fileType) {
            const url = new URL("{{ url_for('gallery') }}", window.location.origin);
            url.searchParams.set('folder', folderPath);
            url.searchParams.set('type', fileType);
            window.location.href = url.toString();
        }

        {% if current_user.is_admin %}
        function showFolderManagement() {
            const modal = new bootstrap.Modal(document.getElementById('folderManagementModal'));
            loadFolderManagementData();
            modal.show();
        }

        function loadFolderManagementData() {
            ['image', 'video', 'audio'].forEach(fileType => {
                const container = document.getElementById(fileType + 'Folders');
                container.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div></div>';
                
                fetch(`/api/folders?type=${fileType}`)
                    .then(response => response.json())
                    .then(data => {
                        displayManagementFolders(data[fileType] || [], container, fileType);
                    })
                    .catch(error => {
                        container.innerHTML = '<small class="text-danger">Error loading folders</small>';
                    });
            });
        }

        function displayManagementFolders(folders, container, fileType) {
            container.innerHTML = '';
            
            if (folders.length === 0) {
                container.innerHTML = '<small class="text-muted">No folders</small>';
                return;
            }
            
            renderManagementFolderLevel(folders, container, fileType, 0);
        }

        function renderManagementFolderLevel(folders, container, fileType, depth) {
            folders.forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item';
                folderItem.style.marginLeft = (depth * 15) + 'px';
                
                folderItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <div class="flex-grow-1">
                            <i class="bi bi-folder me-2"></i>${folder.name}
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="navigateToFolder('${folder.path}', '${fileType}')" title="Browse folder">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteFolder('${folder.path}', '${fileType}')" title="Delete folder">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(folderItem);
                
                if (folder.children && folder.children.length > 0) {
                    renderManagementFolderLevel(folder.children, container, fileType, depth + 1);
                }
            });
        }

        function deleteFolder(folderPath, fileType) {
            currentFolderPath = folderPath;
            currentFolderType = fileType;
            
            document.getElementById('deleteFolderPath').textContent = `${folderPath} (${fileType})`;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteFolderModal'));
            modal.show();
        }

        document.getElementById('confirmDeleteFolder').addEventListener('click', function() {
            if (!currentFolderPath || !currentFolderType) return;
            
            fetch('/api/delete-folder', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    folder_path: currentFolderPath,
                    file_type: currentFolderType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Folder deleted successfully');
                    // Clear cache and refresh
                    folderStructureCache = {};
                    loadFolderManagementData();
                    bootstrap.Modal.getInstance(document.getElementById('deleteFolderModal')).hide();
                }
            })
            .catch(error => {
                alert('Error deleting folder: ' + error);
            });
        });

        function refreshFolderManagement() {
            folderStructureCache = {};
            loadFolderManagementData();
        }
        {% endif %}
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>