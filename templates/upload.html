{% extends "base.html" %}

{% block title %}Upload - Media Manager{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header">
                <h3 class="card-title mb-0">
                    <i class="bi bi-cloud-upload"></i> Upload Media Files
                </h3>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="uploadForm">
                    <!-- File Type Filter -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="file_type" class="form-label">File Type Filter (Optional)</label>
                            <select class="form-select" id="file_type" name="file_type" onchange="updateFolderOptions()">
                                <option value="">Any Type</option>
                                <option value="image">Images Only</option>
                                <option value="video">Videos Only</option>
                                <option value="audio">Audio Only</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="folder_option" class="form-label">Folder</label>
                            <select class="form-select" id="folder_option" onchange="toggleCustomFolder()">
                                <option value="root">Root Directory</option>
                                <option value="existing">Existing Folder</option>
                                <option value="new">Create New Folder</option>
                                <option value="nested">Create Nested Folder</option>
                            </select>
                        </div>
                    </div>

                    <!-- Existing Folder Selection -->
                    <div class="row mb-3" id="existingFolderRow" style="display: none;">
                        <div class="col-12">
                            <label for="existing_folder" class="form-label">Select Existing Folder</label>
                            <select class="form-select" id="existing_folder">
                                <option value="">Choose folder...</option>
                            </select>
                            <div class="form-text">Select from existing folders (shows nested structure)</div>
                        </div>
                    </div>

                    <!-- Custom Folder Input -->
                    <div class="row mb-3" id="customFolderRow" style="display: none;">
                        <div class="col-12">
                            <label for="custom_folder" class="form-label">New Folder Name</label>
                            <input type="text" class="form-control" id="custom_folder" name="custom_folder" 
                                   placeholder="e.g., Action Movies, Family Photos, Jazz Music">
                            <div class="form-text">Letters, numbers, spaces, hyphens, and underscores only</div>
                        </div>
                    </div>

                    <!-- Nested Folder Input -->
                    <div class="row mb-3" id="nestedFolderRow" style="display: none;">
                        <div class="col-12">
                            <label for="nested_folder" class="form-label">Nested Folder Path</label>
                            <input type="text" class="form-control" id="nested_folder" name="custom_folder" 
                                   placeholder="e.g., Anime/CowboyBebop, Movies/Action/2023, Music/Jazz/Miles Davis">
                            <div class="form-text">
                                Use forward slashes (/) to create nested folders.<br>
                                Example: "Anime/CowboyBebop" creates Anime folder with CowboyBebop subfolder
                            </div>
                        </div>
                    </div>

                    <!-- Mobile-Friendly Upload Zone -->
                    <div class="upload-zone" id="uploadZone">
                        <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                        <h4>Select Files to Upload</h4>
                        <p class="text-muted">Tap button below to choose files</p>
                        
                        <!-- Multiple file input options for better mobile compatibility -->
                        <input type="file" name="files" id="fileInput" multiple 
                               accept="image/*,video/*,audio/*"
                               class="d-none">
                        
                        <!-- Separate inputs for mobile devices that might have issues with multiple -->
                        <input type="file" name="single_file" id="singleFileInput" 
                               accept="image/*,video/*,audio/*"
                               class="d-none">
                        
                        <div class="btn-group-vertical gap-2">
                            <button type="button" class="btn btn-primary" id="selectFilesBtn">
                                <i class="bi bi-file-earmark-plus"></i> Select Files
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="selectSingleBtn">
                                <i class="bi bi-file-earmark"></i> Select Single File
                            </button>
                        </div>
                        
                        <!-- Mobile-specific drag and drop area -->
                        <div class="mt-3 d-none d-md-block">
                            <small class="text-muted">Or drag & drop files here (desktop only)</small>
                        </div>
                    </div>

                    <!-- Debug Information -->
                    <div id="debugInfo" class="mt-2" style="display: none;">
                        <small class="text-muted">
                            <strong>Debug:</strong>
                            <div id="debugContent"></div>
                        </small>
                    </div>
                    
                    <div id="fileList" class="mt-3" style="display: none;">
                        <h5>Selected Files:</h5>
                        <div id="selectedFiles"></div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearFiles()">
                                <i class="bi bi-x-circle"></i> Clear Files
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>
                            <i class="bi bi-upload"></i> Upload Files
                        </button>
                        <a href="{{ url_for('gallery') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Gallery
                        </a>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="toggleDebug()">
                            <i class="bi bi-bug"></i> Debug
                        </button>
                    </div>
                    
                    <div class="progress mt-3" id="uploadProgress" style="display: none;">
                        <div class="progress-bar" role="progressbar" style="width: 0%">
                            <span class="progress-text">0%</span>
                        </div>
                    </div>
                </form>
                
                <!-- Mobile Upload Tips -->
                <div class="alert alert-info mt-4 d-md-none">
                    <h6><i class="bi bi-phone"></i> Mobile Upload Tips:</h6>
                    <ul class="mb-0">
                        <li>Use "Select Files" or "Select Single File" buttons</li>
                        <li>Some browsers may limit file types</li>
                        <li>Large files may take longer to upload</li>
                        <li>Keep the page open during upload</li>
                    </ul>
                </div>

                <div class="mt-4">
                    <h5>Supported File Types & Size Limits:</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Images:</strong><br>
                            <small class="text-muted">JPG, PNG, GIF, BMP, WebP</small><br>
                            <span class="badge bg-info">Max: 100 MB</span>
                        </div>
                        <div class="col-md-4">
                            <strong>Videos:</strong><br>
                            <small class="text-muted">MP4, AVI, MKV, MOV, WebM</small><br>
                            <span class="badge bg-success">Max: 10 GB</span>
                        </div>
                        <div class="col-md-4">
                            <strong>Audio:</strong><br>
                            <small class="text-muted">MP3, WAV, FLAC, AAC, OGG</small><br>
                            <span class="badge bg-warning">Max: 500 MB</span>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <h6><i class="bi bi-info-circle"></i> Large File Upload Tips:</h6>
                        <ul class="mb-0">
                            <li><strong>Videos up to 10GB</strong> are now supported</li>
                            <li>Large files may take several minutes to upload</li>
                            <li>Keep your browser window open during upload</li>
                            <li>Use a stable internet connection for best results</li>
                            <li>Upload progress will show for files over 100MB</li>
                        </ul>
                    </div>
                </div>

                <!-- Existing Folders Display -->
                <div class="mt-4">
                    <h5>Existing Folder Structure:</h5>
                    <div class="row">
                        {% for file_type, folders in folder_structure.items() %}
                        {% if folders %}
                        <div class="col-md-4">
                            <strong>{{ file_type.title() }}:</strong>
                            <ul class="list-unstyled ms-3">
                                {% for folder in folders %}
                                <li style="margin-left: {{ folder.depth * 20 }}px;">
                                    <i class="bi bi-folder"></i> 
                                    {{ folder.name }}
                                    {% if folder.depth > 0 %}
                                        <small class="text-muted">({{ folder.display_name }})</small>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Store folder structure data
const folderStructure = {{ folder_structure|tojson }};
let selectedFilesList = [];
let debugMode = false;

// Mobile detection
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

function debugLog(message) {
    if (debugMode) {
        const debugContent = document.getElementById('debugContent');
        const timestamp = new Date().toLocaleTimeString();
        debugContent.innerHTML += `[${timestamp}] ${message}<br>`;
        console.log('[Upload Debug]', message);
    }
}

function toggleDebug() {
    debugMode = !debugMode;
    const debugInfo = document.getElementById('debugInfo');
    debugInfo.style.display = debugMode ? 'block' : 'none';
    if (debugMode) {
        debugLog(`Debug mode enabled. Mobile detected: ${isMobile}`);
        debugLog(`User agent: ${navigator.userAgent}`);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const singleFileInput = document.getElementById('singleFileInput');
    const selectFilesBtn = document.getElementById('selectFilesBtn');
    const selectSingleBtn = document.getElementById('selectSingleBtn');
    const fileList = document.getElementById('fileList');
    const selectedFiles = document.getElementById('selectedFiles');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadForm = document.getElementById('uploadForm');
    const uploadProgress = document.getElementById('uploadProgress');
    
    debugLog('DOM loaded, initializing upload functionality');
    
    // Button click handlers
    selectFilesBtn.addEventListener('click', function(e) {
        e.preventDefault();
        debugLog('Select Files button clicked');
        fileInput.click();
    });
    
    selectSingleBtn.addEventListener('click', function(e) {
        e.preventDefault();
        debugLog('Select Single File button clicked');
        singleFileInput.click();
    });
    
    // File input change handlers
    fileInput.addEventListener('change', function(e) {
        debugLog(`Multiple file input changed. Files selected: ${e.target.files.length}`);
        handleFiles(e.target.files, 'multiple');
    });
    
    singleFileInput.addEventListener('change', function(e) {
        debugLog(`Single file input changed. Files selected: ${e.target.files.length}`);
        handleFiles(e.target.files, 'single');
    });
    
    // Drag and drop for desktop only
    if (!isMobile) {
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadZone.classList.add('dragover');
            debugLog('Drag over detected');
        });
        
        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            debugLog('Drag leave detected');
        });
        
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            debugLog(`Drop detected. Files: ${e.dataTransfer.files.length}`);
            handleFiles(e.dataTransfer.files, 'drop');
        });
    }
    
    function handleFiles(files, source) {
        debugLog(`handleFiles called with ${files.length} files from ${source}`);
        
        if (files.length === 0) {
            debugLog('No files provided to handleFiles');
            return;
        }
        
        // File size limits (in bytes)
        const fileSizeLimits = {
            'image': 100 * 1024 * 1024,      // 100MB
            'video': 10 * 1024 * 1024 * 1024, // 10GB
            'audio': 500 * 1024 * 1024       // 500MB
        };
        
        // Add new files to existing selection
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            debugLog(`Processing file: ${file.name}, size: ${file.size}, type: ${file.type}`);
            
            // Check file size
            const fileType = getFileType(file.name).toLowerCase();
            const maxSize = fileSizeLimits[fileType] || fileSizeLimits['video']; // Default to video limit
            
            if (file.size > maxSize) {
                const maxSizeFormatted = formatFileSize(maxSize);
                const fileSizeFormatted = formatFileSize(file.size);
                alert(`File "${file.name}" (${fileSizeFormatted}) exceeds the maximum size limit of ${maxSizeFormatted} for ${fileType} files.`);
                debugLog(`File ${file.name} rejected: size ${file.size} exceeds limit ${maxSize}`);
                continue;
            }
            
            // Show warning for large files
            if (file.size > 500 * 1024 * 1024) { // > 500MB
                const fileSizeFormatted = formatFileSize(file.size);
                if (!confirm(`"${file.name}" is ${fileSizeFormatted}. Large files may take a long time to upload. Continue?`)) {
                    debugLog(`User cancelled upload of large file: ${file.name}`);
                    continue;
                }
            }
            
            // Check if file is already selected
            const isDuplicate = selectedFilesList.some(f => 
                f.name === file.name && f.size === file.size && f.lastModified === file.lastModified
            );
            
            if (!isDuplicate) {
                selectedFilesList.push(file);
                debugLog(`Added file to selection: ${file.name}`);
            } else {
                debugLog(`Skipped duplicate file: ${file.name}`);
            }
        }
        
        updateFileDisplay();
    }
    
    function updateFileDisplay() {
        debugLog(`Updating file display with ${selectedFilesList.length} files`);
        selectedFiles.innerHTML = '';
        
        if (selectedFilesList.length === 0) {
            fileList.style.display = 'none';
            uploadBtn.disabled = true;
            return;
        }
        
        selectedFilesList.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'card mb-2';
            fileItem.innerHTML = `
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${file.name}</strong>
                            <small class="text-muted">(${formatFileSize(file.size)})</small>
                            <br><small class="text-muted">Type: ${file.type || 'Unknown'}</small>
                        </div>
                        <div>
                            <span class="badge bg-primary">${getFileType(file.name)}</span>
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeFile(${index})">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            selectedFiles.appendChild(fileItem);
        });
        
        fileList.style.display = 'block';
        uploadBtn.disabled = false;
        debugLog('File display updated successfully');
    }
    
    // Global function to remove files
    window.removeFile = function(index) {
        debugLog(`Removing file at index ${index}`);
        selectedFilesList.splice(index, 1);
        updateFileDisplay();
    };
    
    window.clearFiles = function() {
        debugLog('Clearing all files');
        selectedFilesList = [];
        fileInput.value = '';
        singleFileInput.value = '';
        updateFileDisplay();
    };
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function getFileType(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
        const videoExts = ['mp4', 'avi', 'mkv', 'mov', 'wmv', 'flv', 'webm', 'm4v'];
        const audioExts = ['mp3', 'wav', 'flac', 'aac', 'ogg', 'm4a', 'wma'];
        
        if (imageExts.includes(ext)) return 'Image';
        if (videoExts.includes(ext)) return 'Video';
        if (audioExts.includes(ext)) return 'Audio';
        return 'Unknown';
    }
    
    // Upload with progress
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        debugLog('Form submission started');
        
        if (selectedFilesList.length === 0) {
            alert('Please select files to upload');
            return;
        }
        
        // Set the custom folder value based on selection
        const folderOption = document.getElementById('folder_option').value;
        const customFolderInput = document.getElementById('custom_folder');
        const nestedFolderInput = document.getElementById('nested_folder');
        
        if (folderOption === 'existing') {
            const existingFolder = document.getElementById('existing_folder').value;
            customFolderInput.value = existingFolder;
        } else if (folderOption === 'root') {
            customFolderInput.value = '';
        } else if (folderOption === 'nested') {
            customFolderInput.value = nestedFolderInput.value;
        }
        
        const formData = new FormData();
        
        // Add all selected files
        selectedFilesList.forEach(file => {
            formData.append('files', file);
        });
        
        // Add other form data
        formData.append('file_type', document.getElementById('file_type').value);
        formData.append('custom_folder', customFolderInput.value);
        
        debugLog(`Uploading ${selectedFilesList.length} files`);
        uploadProgress.style.display = 'block';
        uploadBtn.disabled = true;
        
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                const progressBar = uploadProgress.querySelector('.progress-bar');
                const progressText = uploadProgress.querySelector('.progress-text');
                progressBar.style.width = percentComplete + '%';
                progressText.textContent = Math.round(percentComplete) + '%';
                debugLog(`Upload progress: ${Math.round(percentComplete)}%`);
            }
        });
        
        xhr.addEventListener('load', function() {
            debugLog(`Upload completed with status: ${xhr.status}`);
            if (xhr.status === 200) {
                debugLog('Upload successful, redirecting to gallery');
                window.location.href = "{{ url_for('gallery') }}";
            } else {
                debugLog(`Upload failed with status: ${xhr.status}`);
                alert('Upload failed. Please try again.');
                uploadBtn.disabled = false;
                uploadProgress.style.display = 'none';
            }
        });
        
        xhr.addEventListener('error', function() {
            debugLog('Upload error occurred');
            alert('Upload failed. Please check your connection and try again.');
            uploadBtn.disabled = false;
            uploadProgress.style.display = 'none';
        });
        
        xhr.addEventListener('timeout', function() {
            debugLog('Upload timed out');
            alert('Upload timed out. Please try again with smaller files or check your internet connection.');
            uploadBtn.disabled = false;
            uploadProgress.style.display = 'none';
        });
        
        // Set timeout based on file sizes
        const totalSize = selectedFilesList.reduce((sum, file) => sum + file.size, 0);
        let timeoutMs = 300000; // 5 minutes default
        
        if (totalSize > 1024 * 1024 * 1024) { // > 1GB
            timeoutMs = 1800000; // 30 minutes
        } else if (totalSize > 100 * 1024 * 1024) { // > 100MB
            timeoutMs = 900000; // 15 minutes
        }
        
        debugLog(`Setting upload timeout to ${timeoutMs / 1000} seconds for ${formatFileSize(totalSize)} total`);
        
        xhr.timeout = timeoutMs;
        xhr.open('POST', uploadForm.action);
        xhr.send(formData);
    });
});

function updateFolderOptions() {
    const fileType = document.getElementById('file_type').value;
    const existingFolderSelect = document.getElementById('existing_folder');
    
    // Clear existing options
    existingFolderSelect.innerHTML = '<option value="">Choose folder...</option>';
    
    if (fileType && folderStructure[fileType]) {
        folderStructure[fileType].forEach(folder => {
            const option = document.createElement('option');
            option.value = folder.path;
            option.textContent = folder.display_name;
            
            // Add indentation for nested folders
            if (folder.depth > 0) {
                option.style.paddingLeft = (folder.depth * 20) + 'px';
            }
            
            existingFolderSelect.appendChild(option);
        });
    } else if (!fileType) {
        // Show all folders from all types
        ['image', 'video', 'audio'].forEach(type => {
            if (folderStructure[type]) {
                folderStructure[type].forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder.path;
                    option.textContent = `${folder.display_name} (${type})`;
                    
                    if (folder.depth > 0) {
                        option.style.paddingLeft = (folder.depth * 20) + 'px';
                    }
                    
                    existingFolderSelect.appendChild(option);
                });
            }
        });
    }
}

function toggleCustomFolder() {
    const folderOption = document.getElementById('folder_option').value;
    const existingFolderRow = document.getElementById('existingFolderRow');
    const customFolderRow = document.getElementById('customFolderRow');
    const nestedFolderRow = document.getElementById('nestedFolderRow');
    
    // Hide all rows first
    existingFolderRow.style.display = 'none';
    customFolderRow.style.display = 'none';
    nestedFolderRow.style.display = 'none';
    
    if (folderOption === 'existing') {
        existingFolderRow.style.display = 'block';
        updateFolderOptions();
    } else if (folderOption === 'new') {
        customFolderRow.style.display = 'block';
    } else if (folderOption === 'nested') {
        nestedFolderRow.style.display = 'block';
    }
}
</script>
{% endblock %}